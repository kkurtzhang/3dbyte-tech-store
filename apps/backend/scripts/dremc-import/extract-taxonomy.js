#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const DATA_DIR = path.join(__dirname, 'data');

// Read collections
const collections = JSON.parse(fs.readFileSync(path.join(DATA_DIR, 'dremc-collections.json'), 'utf8')).collections;

// Read all product pages
const allProducts = [];
for (let i = 1; i <= 7; i++) {
  const pageData = JSON.parse(fs.readFileSync(path.join(DATA_DIR, `products-page${i}.json`), 'utf8'));
  allProducts.push(...pageData.products);
}

console.log(`Total products loaded: ${allProducts.length}`);

// Extract unique product_types with counts
const productTypeMap = new Map();
allProducts.forEach(product => {
  const type = product.product_type || 'Unknown';
  productTypeMap.set(type, (productTypeMap.get(type) || 0) + 1);
});

const productTypes = Array.from(productTypeMap.entries())
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);

// Extract unique vendors with counts (excluding DREMC and DREMC-STORE)
const vendorMap = new Map();
const dremcVendors = { 'DREMC': 0, 'DREMC-STORE': 0 };

allProducts.forEach(product => {
  const vendor = product.vendor || 'Unknown';
  if (vendor === 'DREMC' || vendor === 'DREMC-STORE') {
    dremcVendors[vendor]++;
  } else {
    vendorMap.set(vendor, (vendorMap.get(vendor) || 0) + 1);
  }
});

const vendors = Array.from(vendorMap.entries())
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);

// Prepare collections data (cleaned up, removing large image objects)
const cleanCollections = collections.map(col => ({
  id: col.id,
  title: col.title,
  handle: col.handle,
  description: col.description ? col.description.replace(/<[^>]*>/g, '').trim() : '',
  published_at: col.published_at,
  updated_at: col.updated_at,
  products_count: col.products_count
}));

// Save collections
fs.writeFileSync(
  path.join(DATA_DIR, 'dremc-collections.json'),
  JSON.stringify(cleanCollections, null, 2)
);

// Save product types
fs.writeFileSync(
  path.join(DATA_DIR, 'dremc-product-types.json'),
  JSON.stringify(productTypes, null, 2)
);

// Save vendors
fs.writeFileSync(
  path.join(DATA_DIR, 'dremc-vendors.json'),
  JSON.stringify(vendors, null, 2)
);

// Generate summary markdown
const summary = `# DREMC Category Structure Summary

Extracted on: ${new Date().toISOString()}

## Overview

- **Total Collections**: ${collections.length}
- **Total Products**: ${allProducts.length}
- **Unique Product Types**: ${productTypes.length}
- **Unique Vendors (excluding DREMC)**: ${vendors.length}

## Collections (${collections.length})

| Collection | Products | Handle |
|------------|----------|--------|
${cleanCollections.map(c => `| ${c.title} | ${c.products_count} | ${c.handle} |`).join('\n')}

## Product Types (${productTypes.length})

| Product Type | Count |
|--------------|-------|
${productTypes.map(t => `| ${t.name} | ${t.count} |`).join('\n')}

## Vendors (${vendors.length})

| Vendor | Product Count |
|--------|---------------|
${vendors.map(v => `| ${v.name} | ${v.count} |`).join('\n')}

## Excluded DREMC Vendors

The following DREMC-owned brands are excluded from vendor counts:

| Vendor | Product Count |
|--------|---------------|
${Object.entries(dremcVendors).map(([name, count]) => `| ${name} | ${count} |`).join('\n')}

## Data Files

- \`dremc-collections.json\` - Full collection metadata
- \`dremc-product-types.json\` - All product types with counts
- \`dremc-vendors.json\` - All vendors with product counts

---

*Generated by DREMC Category Structure Extractor*
`;

fs.writeFileSync(
  path.join(DATA_DIR, 'dremc-category-summary.md'),
  summary
);

console.log('\n=== Extraction Complete ===');
console.log(`Collections: ${cleanCollections.length}`);
console.log(`Product Types: ${productTypes.length}`);
console.log(`Vendors: ${vendors.length}`);
console.log(`Total Products: ${allProducts.length}`);
console.log(`\nOutput files saved to: ${DATA_DIR}`);
